{% extends "base.html" %}
{% load static %}

{% block content %}

<!-- =========================
     Hero
========================== -->
<section class="hero">
  <div class="hero-overlay"></div>
  <div class="hero-container">
    <div class="hero-content">
      <div class="hero-badge">
        <i class="fas fa-chalkboard-teacher"></i>
        <span>Find a session that fits you</span>
      </div>
      <h1 class="hero-title">Browse Tutoring Sessions</h1>
      <p class="hero-subtitle">
        Filter by subject, tutor, location (or “remote”), date, time, and capacity type. Click request to join.
      </p>

      <div class="hero-cta">
        <a href="#filters" class="btn btn-primary btn-hero">
          <i class="fas fa-search"></i>
          <span>Search Sessions</span>
        </a>
        <a href="{% url 'tutoringsession:friends_sessions' %}" class="btn btn-secondary btn-hero">
          <i class="fas fa-user-friends"></i>
          <span>Friends’ Sessions</span>
        </a>
      </div>
    </div>
  </div>
</section>

<!-- =========================
     Filters
========================== -->
<section id="filters" class="section-container" style="margin-top:-3rem;">
  <div class="profile-section">
    <div class="section-header">
      <h2><i class="fas fa-sliders-h"></i> Search Filters</h2>
    </div>
    <div class="section-content">
      <form method="get" class="auth-form" style="margin:0;">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="subject">Subject</label>
            <input id="subject" name="subject" type="text" class="auth-form-input"
                   value="{{ selected.subject }}" placeholder="e.g., CS 1332, Calculus II">
          </div>

          <div class="form-group">
            <label class="form-label" for="tutor">Tutor</label>
            <input id="tutor" name="tutor" type="text" class="auth-form-input"
                   value="{{ selected.tutor }}" placeholder="Username or name">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="location">Location</label>
            <input id="location" name="location" type="text" class="auth-form-input"
                   value="{{ selected.location }}" placeholder="Campus, library, or 'remote'">
            <div class="form-help"><i class="fas fa-info-circle"></i> Use “remote” or “online” to see virtual sessions.</div>
          </div>

          <div class="form-group">
            <label class="form-label" for="date">Date</label>
            <input id="date" name="date" type="date" class="auth-form-input" value="{{ selected.date }}">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="time">Time</label>
            <input id="time" name="time" type="text" class="auth-form-input"
                   value="{{ selected.time }}" placeholder="HH:MM or 3:30 PM">
            <div class="form-help"><i class="fas fa-info-circle"></i> Matches sessions whose time range contains this time; sessions with blank times count as “any time”.</div>
          </div>

          <div class="form-group">
            <label class="form-label" for="capacity_type">Capacity</label>
            <select id="capacity_type" name="capacity_type" class="auth-form-input">
              <option value="">Any capacity</option>
              <option value="one_on_one" {% if selected.capacity_type == 'one_on_one' %}selected{% endif %}>1-on-1</option>
              <option value="group" {% if selected.capacity_type == 'group' %}selected{% endif %}>Group</option>
            </select>
          </div>
        </div>

        <div class="form-options" style="margin-top:.5rem;">
          <label class="checkbox-label">
            <input type="checkbox" name="include_full" value="1" {% if selected.include_full == '1' %}checked{% endif %}>
            Include full sessions
          </label>
          <div>
            <button class="btn btn-primary btn-lg" type="submit">
              <i class="fas fa-search"></i> Search
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>

<!-- =========================
     Map
========================== -->
{% if GOOGLE_MAPS_API_KEY %}
<section class="section-container">
  <div class="profile-section">
    <div class="section-header">
      <h2><i class="fas fa-map-marker-alt"></i> Map</h2>
    </div>
    <div class="section-content">
      <div id="map" style="width:100%; height:380px; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); border:1px solid var(--border-color);"></div>
    </div>
  </div>
</section>
{% endif %}

<!-- =========================
     Results
========================== -->
<section class="section-container">
  <div class="profile-section">
    <div class="section-header">
      <h2><i class="fas fa-list"></i> Sessions <span style="color:var(--text-secondary); font-weight:600;">({{ sessions|length }})</span></h2>
    </div>

    <div class="section-content">
      {% if sessions %}
        <div class="action-cards">
          {% for s in sessions %}
            <div id="session-{{ s.id }}" class="action-card">
              <div class="action-icon">
                <i class="fas fa-book-open"></i>
              </div>

              <div class="action-content">
                <h3>
                  {{ s.subject }}
                  {% if s.capacity == 1 %}
                    <span class="section-badge" style="margin-left:.5rem;">1-on-1</span>
                  {% else %}
                    <span class="section-badge" style="margin-left:.5rem;">Group ({{ s.capacity }})</span>
                  {% endif %}
                  {% if s.is_remote %}
                    <span class="section-badge" style="margin-left:.5rem; background:var(--bg-secondary); color:var(--text-secondary);">Remote</span>
                  {% endif %}
                </h3>

                <p style="margin-top:.35rem;">
                  <span style="color:var(--text-secondary);">
                    <i class="far fa-calendar"></i> {{ s.date }}
                    &nbsp;&nbsp; <i class="far fa-clock"></i>
                    {% if s.start_time %}{{ s.start_time }}{% else %}Any{% endif %}
                    –
                    {% if s.end_time %}{{ s.end_time }}{% else %}Any{% endif %}
                    &nbsp;&nbsp; <i class="fas fa-map-marker-alt"></i> {{ s.location }}
                    &nbsp;&nbsp; <i class="fas fa-chalkboard-teacher"></i> {{ s.tutor.username }}
                    &nbsp;&nbsp; <i class="fas fa-users"></i> {{ s.seats_taken }} / {{ s.capacity }}
                  </span>
                </p>

                {% if s.description %}
                  <p style="margin-top:.35rem; color:var(--text-light);">{{ s.description }}</p>
                {% endif %}
              </div>

              <i class="fas fa-arrow-right action-arrow"></i>

              <div class="profile-actions" style="margin-left:auto;">
                {% if s.is_full %}
                  <button class="btn btn-outline-nav" disabled>Full</button>
                {% else %}
                  {% if user.is_authenticated %}
                    <form method="post" action="{% url 'tutoringsession:request_session' s.id %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-hand-paper"></i> Request Session
                      </button>
                    </form>
                  {% else %}
                    <a class="btn btn-primary" href="{% url 'accounts:login' %}?next={% url 'tutoringsession:index' %}">
                      Log in to request
                    </a>
                  {% endif %}
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-profile" style="padding:3rem 1.5rem;">
          <div class="empty-icon"><i class="far fa-calendar-times"></i></div>
          <h2>No sessions match your filters</h2>
          <p>Try broadening your search (different date/time or remove “Include full”).</p>
          <div class="empty-actions">
            <a href="{% url 'tutoringsession:index' %}" class="btn btn-secondary">Clear Filters</a>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</section>

{% if GOOGLE_MAPS_API_KEY %}
  {{ markers|json_script:"session-markers" }}
{% endif %}

{% endblock %}

{% block extra_js %}
{% if GOOGLE_MAPS_API_KEY %}
<script>
(function(){
  function init() {
    const el = document.getElementById("session-markers");
    const markers = el ? JSON.parse(el.textContent) : [];
    const mapEl = document.getElementById("map");
    if (!mapEl) return;

    const fallback = { lat: 33.7756, lng: -84.3963 }; // GT fallback
    const center = markers.length ? { lat: markers[0].lat, lng: markers[0].lng } : fallback;

    const map = new google.maps.Map(mapEl, {
      zoom: markers.length ? 12 : 11,
      center
    });

    const bounds = new google.maps.LatLngBounds();
    const info = new google.maps.InfoWindow();

    markers.forEach(m => {
      const mk = new google.maps.Marker({
        position: { lat: m.lat, lng: m.lng },
        map,
        title: m.title
      });
      bounds.extend(mk.getPosition());
      mk.addListener("click", () => {
        const html = `
          <div style="min-width:200px;">
            <strong>${m.title}</strong><br>
            <small>${m.location}</small><br>
            <small>Tutor: ${m.tutor} • ${m.date}</small><br>
            <a href="#session-${m.id}">View in list</a>
          </div>`;
        info.setContent(html);
        info.open(map, mk);

        const li = document.getElementById("session-" + m.id);
        if (li) {
          li.scrollIntoView({ behavior: "smooth", block: "center" });
          li.style.boxShadow = "0 0 0 3px rgba(37, 99, 235, 0.25)";
          setTimeout(() => (li.style.boxShadow = ""), 1200);
        }
      });
    });

    if (markers.length > 1) map.fitBounds(bounds);
  }

  window.__initSessionsMap = init;
})();
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=__initSessionsMap"></script>
{% endif %}
{% endblock %}